class e{constructor(e={}){this.apiUrl=e.apiUrl||"/api/home/gallery",this.container=e.container,this.renderImage=e.renderImage,this.batchSize=e.batchSize||20,this.extraParams=e.extraParams||{},this.hasMore=!0,this.loading=!1,this.observer=null,this.cache=new Map,this.prefetchQueue=[],this.connectionSpeed=this._detectConnectionSpeed(),this.adaptiveBatchSize=this._calculateAdaptiveBatchSize(),this.prefetchInProgress=!1,this.shownImageIds=new Set((e.shownImageIds||[]).map(e=>parseInt(e,10)).filter(e=>!isNaN(e)&&e>0)),this.shownAlbumIds=new Set((e.shownAlbumIds||[]).map(e=>parseInt(e,10)).filter(e=>!isNaN(e)&&e>0))}_detectConnectionSpeed(){if("connection"in navigator){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(e){const t=e.effectiveType;if("slow-2g"===t||"2g"===t)return"slow";if("3g"===t)return"medium";if("4g"===t)return"fast"}}return"medium"}_calculateAdaptiveBatchSize(){const e=this.batchSize;switch(this.connectionSpeed){case"slow":return Math.max(10,Math.floor(.5*e));case"fast":return Math.floor(1.5*e);default:return e}}_getCacheKey(e){return`${this.apiUrl}:${e}:${this.adaptiveBatchSize}:${JSON.stringify(this.extraParams)}`}async loadMore(){if(!this.loading&&this.hasMore){this.loading=!0;try{if(this.prefetchQueue.length>0){const e=this.prefetchQueue.shift();return this._processImageData(e),this.loading=!1,void this._prefetchNextBatch()}const e=await this._fetchBatch();e&&(this._processImageData(e),this._prefetchNextBatch())}catch(e){}finally{this.loading=!1}}}async _fetchBatch(){const e=this._getCacheKey(this.shownImageIds.size);if(this.cache.has(e))return this.cache.get(e);let t,s;try{s=new AbortController,t=setTimeout(()=>s.abort(),1e4);const i=new URL(this.apiUrl,window.location.origin),a=i.searchParams;a.set("exclude",Array.from(this.shownImageIds).join(",")),a.set("excludeAlbums",Array.from(this.shownAlbumIds).join(",")),a.set("limit",String(this.adaptiveBatchSize));const r=new Set(["exclude","excludeAlbums","limit"]);Object.entries(this.extraParams).forEach(([e,t])=>{null!=t&&""!==t&&(r.has(e)||a.set(e,String(t)))});const n=await fetch(i.toString(),{signal:s.signal,priority:"high"});if(!n.ok)return null;const h=await n.json();return this.cache.size<5&&this.cache.set(e,h),h}catch(i){return i.name,null}finally{t&&clearTimeout(t)}}_processImageData(e){Array.isArray(e.images)&&e.images.forEach(e=>{const t=parseInt(e.id,10);isNaN(t)||t<=0||this.shownImageIds.has(t)||(this.renderImage&&this.renderImage(e),this.shownImageIds.add(t))}),Array.isArray(e.newAlbumIds)&&e.newAlbumIds.forEach(e=>{const t=parseInt(e,10);!isNaN(t)&&t>0&&this.shownAlbumIds.add(t)}),this.hasMore=Boolean(e.hasMore)}async _prefetchNextBatch(){if(!this.prefetchInProgress&&this.hasMore&&"slow"!==this.connectionSpeed){this.prefetchInProgress=!0;try{const e=async()=>{const e=await this._fetchBatch();e&&e.images&&e.images.length>0&&this.prefetchQueue.push(e),this.prefetchInProgress=!1};"requestIdleCallback"in window?requestIdleCallback(()=>e(),{timeout:2e3}):setTimeout(()=>e(),100)}catch(e){this.prefetchInProgress=!1}}}observe(e){e&&(this.observer&&this.observer.disconnect(),this.observer=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&this.hasMore&&!this.loading&&this.loadMore()},{rootMargin:"200px"}),this.observer.observe(e))}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null)}startBackgroundLoading(){requestAnimationFrame(()=>{this.loadMore()})}hasMoreImages(){return this.hasMore}isLoading(){return this.loading}getLoadedCount(){return this.shownImageIds.size}}export{e as H};
