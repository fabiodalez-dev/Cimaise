{% extends "frontend/_layout.twig" %}

{% block styles %}
<style nonce="{{ csp_nonce() }}">
/* Pure CSS Masonry (Columns) - Instant & Jank-free */
.masonry-container {
  width: 100%;
  max-width: 100%;
  padding: 0 10px; /* Safe padding */
  box-sizing: border-box;
}

.masonry-grid {
  /* Default Mobile: 1 Column */
  column-count: {{ home_settings.masonry_col_mobile|default(1) }};
  column-gap: {{ home_settings.masonry_gap_h|default(10) }}px;
  width: 100%;
}

.masonry-item {
  /* Prevent items from splitting across columns */
  break-inside: avoid;
  page-break-inside: avoid;
  -webkit-column-break-inside: avoid;
  
  margin-bottom: {{ home_settings.masonry_gap_v|default(10) }}px;
  display: block;
  width: 100%;
  /* Force hardware acceleration to prevent rendering glitches */
  transform: translateZ(0);
}

.masonry-item img {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 4px; /* Optional polish */
}

.masonry-loading {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  margin: 2rem auto 0;
  color: #444;
  font-size: 0.95rem;
}
.masonry-loading.is-visible {
  display: flex;
}
.masonry-loading .spinner {
  width: 18px;
  height: 18px;
  border: 2px solid rgba(0, 0, 0, 0.15);
  border-top-color: rgba(0, 0, 0, 0.6);
  border-radius: 9999px;
  animation: masonrySpin 0.8s linear infinite;
}
@keyframes masonrySpin {
  to { transform: rotate(360deg); }
}

@media (min-width: 641px) {
  .masonry-grid {
    column-count: {{ home_settings.masonry_col_tablet|default(3) }};
  }
}

@media (min-width: 1025px) {
  .masonry-grid {
    column-count: {{ home_settings.masonry_col_desktop|default(5) }};
  }
  .masonry-container.masonry-boxed {
    max-width: 1400px; /* Reduced from 1600px for more boxed feel */
    margin: 0 auto;
    padding: 0 80px; /* Doubled padding for more whitespace */
  }
}

/* Remove JS-specific classes */
.masonry-grid.masonry-active {
  display: block; /* Just block, columns handle the rest */
}
.masonry-grid::after { content: none; } /* Remove clearfix */
</style>
{% endblock %}

{% block content %}
{% include 'frontend/home/_preloader.twig' %}
{# Hook: frontend_home_before - Before all home page content #}
{{ do_action('frontend_home_before', {base_path: base_path}) }}

{# WebSite JSON-LD for home page #}
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": {{ site_title|default('Portfolio')|json_encode|raw }},
  "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
  {% if meta_description %}
  "description": {{ meta_description|json_encode|raw }},
  {% endif %}
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": "{{ base_path }}/{{ galleries_slug|default('galleries') }}?q={search_term_string}"
    },
    "query-input": "required name=search_term_string"
  }
}
</script>

{% if all_images|length > 0 %}
{# Layout container: boxed on desktop with max-width and padding, full-width on mobile #}
{% set layout_mode = home_settings.masonry_layout_mode|default('fullwidth') %}
<div class="masonry-container{% if layout_mode == 'boxed' %} masonry-boxed{% endif %}">
<div class="masonry-grid"
     data-gap-h="{{ home_settings.masonry_gap_h|default(0) }}"
     data-gap-v="{{ home_settings.masonry_gap_v|default(0) }}"
     data-cols-mobile="{{ home_settings.masonry_col_mobile|default(1) }}"
     data-cols-tablet="{{ home_settings.masonry_col_tablet|default(3) }}"
     data-cols-desktop="{{ home_settings.masonry_col_desktop|default(5) }}">
  {% for image in all_images %}
  <div class="masonry-item">
    <a href="{{ base_path }}/album/{{ image.album_slug|e('html_attr') }}">
      {% set webp_sources = image.sources.webp|default([]) %}
      {% set jpg_sources = image.sources.jpg|default([]) %}
      <picture>
        {% if webp_sources|length > 0 %}
        <source type="image/webp" srcset="{% for src in webp_sources %}{{ base_path }}{{ src }}{% if not loop.last %}, {% endif %}{% endfor %}">
        {% endif %}
        {% if jpg_sources|length > 0 %}
        <source type="image/jpeg" srcset="{% for src in jpg_sources %}{{ base_path }}{{ src }}{% if not loop.last %}, {% endif %}{% endfor %}">
        {% endif %}
        {% set img_src = image.fallback_src|default(image.original_path) %}
        {% set img_url = img_src starts with '/' ? base_path ~ img_src : img_src %}
        {% set img_width = image.width|default(800) %}
        {% set img_height = image.height|default(600) %}
        <img
          src="{{ img_url|e('html_attr') }}"
          alt="{{ image.title|default(image.album_title)|e('html_attr') }}"
          width="{{ img_width }}"
          height="{{ img_height }}"
          style="aspect-ratio: {{ img_width }} / {{ img_height }};"
          loading="lazy"
        >
      </picture>
    </a>
  </div>
  {% endfor %}
</div>
</div>
{% if has_more_images|default(false) %}
<div id="masonry-loading" class="masonry-loading" aria-live="polite" aria-hidden="true">
  <span class="spinner" aria-hidden="true"></span>
  <span>{{ trans('home.masonry_loading') }}</span>
</div>
<script nonce="{{ csp_nonce() }}">
  window.homeLoaderConfig = {
    shownImageIds: {{ shown_image_ids|default([])|json_encode|raw }},
    shownAlbumIds: {{ shown_album_ids|default([])|json_encode|raw }},
    hasMore: true,
    basePath: {{ base_path|json_encode|raw }},
    maxImages: {{ home_settings.masonry_max_images|default(0)|json_encode|raw }}
  };
</script>
<div id="home-load-trigger" class="h-1 w-full pointer-events-none" aria-hidden="true"></div>
{% endif %}
{% else %}
{# Empty state #}
<div class="min-h-screen flex items-center justify-center">
  <div class="text-center px-4">
    <i class="fas fa-images text-6xl text-gray-300 mb-6"></i>
    <h2 class="text-2xl font-semibold text-gray-800 mb-2">{{ home_settings.empty_title|default(trans('home.empty_title'))|e }}</h2>
    <p class="text-gray-600">{{ home_settings.empty_text|default(trans('home.empty_text'))|e }}</p>
  </div>
</div>
{% endif %}

{# Hook: frontend_home_after - After all home page content #}
{{ do_action('frontend_home_after', {base_path: base_path}) }}
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce() }}" type="module" src="{{ base_path }}/assets/js/home-masonry.js"></script>
{% endblock %}
