{% extends "frontend/_layout.twig" %}

{% block styles %}
<style nonce="{{ csp_nonce() }}">
/* Pure Masonry - Wall of Photos - Performance Optimized */

/* Ensure mobile search toggle hidden on desktop (reinforce Tailwind md:hidden) */
@media (min-width: 768px) {
  #mobile-search-toggle {
    display: none !important;
  }
}

/* Base: CSS Grid layout (works without JS, enhanced by Masonry.js) */
.masonry-grid {
  display: grid;
  grid-template-columns: repeat({{ home_settings.masonry_col_mobile|default(2) }}, 1fr);
  gap: {{ home_settings.masonry_gap_v|default(0) }}px {{ home_settings.masonry_gap_h|default(0) }}px;
  /* VISIBLE IMMEDIATELY - no opacity:0 wait */
}

@media (min-width: 641px) {
  .masonry-grid {
    grid-template-columns: repeat({{ home_settings.masonry_col_tablet|default(3) }}, 1fr);
  }
}

@media (min-width: 1025px) {
  .masonry-grid {
    grid-template-columns: repeat({{ home_settings.masonry_col_desktop|default(5) }}, 1fr);
  }
}

/* When Masonry.js takes over */
.masonry-grid.masonry-active {
  display: block;
  position: relative;
}

/* Masonry item base styles */
.masonry-item {
  overflow: hidden;
  contain: layout paint; /* Performance: isolate layout calculations */
  content-visibility: auto; /* Render only visible items */
}

/* When using Masonry.js, items need absolute positioning support */
.masonry-active .masonry-item {
  float: left;
}

.masonry-item a {
  display: block;
}

.masonry-item img {
  display: block;
  width: 100%;
  height: auto;
  /* Browser uses width/height attributes automatically for aspect-ratio */
}

/* Fallback: use img width/height to reserve space before load */
.masonry-item picture,
.masonry-item a {
  display: block;
  position: relative;
}

/* Browser natively uses width/height attributes for layout shift prevention */

/* Fade-in animation for items */
.masonry-item.fade-in {
  animation: masonryFadeIn 0.2s ease-out forwards;
}

@keyframes masonryFadeIn {
  from {
    opacity: 0;
    transform: translate3d(0, 8px, 0);
  }
  to {
    opacity: 1;
    transform: translate3d(0, 0, 0);
  }
}

/* Reduced motion: no animations */
@media (prefers-reduced-motion: reduce) {
  .masonry-grid {
    opacity: 1 !important;
    transition: none !important;
  }
  .masonry-item {
    animation: none !important;
    opacity: 1 !important;
  }
}

/* No-JS fallback: show grid immediately */
.no-js .masonry-grid {
  opacity: 1 !important;
}

/* Layout container styles */
.masonry-container {
  width: 100%;
}

/* Boxed mode: add max-width and padding on desktop only */
@media (min-width: 1025px) {
  .masonry-boxed {
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
    padding-left: 2rem;
    padding-right: 2rem;
  }
}
</style>
{% endblock %}

{% block content %}
{# Hook: frontend_home_before - Before all home page content #}
{{ do_action('frontend_home_before', {base_path: base_path}) }}

{# WebSite JSON-LD for home page #}
<script type="application/ld+json" nonce="{{ csp_nonce() }}">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": {{ site_title|default('Portfolio')|json_encode|raw }},
  "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
  {% if meta_description %}
  "description": {{ meta_description|json_encode|raw }},
  {% endif %}
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": "{{ base_path }}/{{ galleries_slug|default('galleries') }}?q={search_term_string}"
    },
    "query-input": "required name=search_term_string"
  }
}
</script>

{% if all_images|length > 0 %}
{# Layout container: boxed on desktop with max-width and padding, full-width on mobile #}
{% set layout_mode = home_settings.masonry_layout_mode|default('fullwidth') %}
<div class="masonry-container{% if layout_mode == 'boxed' %} masonry-boxed{% endif %}">
<div class="masonry-grid"
     data-gap-h="{{ home_settings.masonry_gap_h|default(0) }}"
     data-gap-v="{{ home_settings.masonry_gap_v|default(0) }}"
     data-cols-mobile="{{ home_settings.masonry_col_mobile|default(2) }}"
     data-cols-tablet="{{ home_settings.masonry_col_tablet|default(3) }}"
     data-cols-desktop="{{ home_settings.masonry_col_desktop|default(5) }}">
  {% for image in all_images %}
  <div class="masonry-item{% if loop.index <= 8 %} fade-in{% endif %}">
    <a href="{{ base_path }}/album/{{ image.album_slug|e('html_attr') }}">
      {% set webp_sources = image.sources.webp|default([]) %}
      {% set jpg_sources = image.sources.jpg|default([]) %}
      <picture>
        {% if webp_sources|length > 0 %}
        <source type="image/webp" srcset="{% for src in webp_sources %}{{ base_path }}{{ src }}{% if not loop.last %}, {% endif %}{% endfor %}">
        {% endif %}
        {% if jpg_sources|length > 0 %}
        <source type="image/jpeg" srcset="{% for src in jpg_sources %}{{ base_path }}{{ src }}{% if not loop.last %}, {% endif %}{% endfor %}">
        {% endif %}
        {% set img_src = image.fallback_src|default(image.original_path) %}
        {% set img_url = img_src starts with '/' ? base_path ~ img_src : img_src %}
        {# First 8 images load immediately, rest lazy #}
        {% set img_width = image.width|default(800) %}
        {% set img_height = image.height|default(600) %}
        <img
          src="{{ img_url|e('html_attr') }}"
          alt="{{ image.title|default(image.album_title)|e('html_attr') }}"
          width="{{ img_width }}"
          height="{{ img_height }}"
          style="aspect-ratio: {{ img_width }} / {{ img_height }};"
          {% if loop.index <= 8 %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
        >
      </picture>
    </a>
  </div>
  {% endfor %}
</div>
</div>
{% else %}
{# Empty state #}
<div class="min-h-screen flex items-center justify-center">
  <div class="text-center px-4">
    <i class="fas fa-images text-6xl text-gray-300 mb-6"></i>
    <h2 class="text-2xl font-semibold text-gray-800 mb-2">{{ home_settings.empty_title|default(trans('home.empty_title'))|e }}</h2>
    <p class="text-gray-600">{{ home_settings.empty_text|default(trans('home.empty_text'))|e }}</p>
  </div>
</div>
{% endif %}

{# Hook: frontend_home_after - After all home page content #}
{{ do_action('frontend_home_after', {base_path: base_path}) }}
{% endblock %}

{% block scripts %}
{# Masonry and imagesLoaded are already loaded in _layout.twig #}
<script nonce="{{ csp_nonce() }}">
(function() {
  'use strict';

  var grid = document.querySelector('.masonry-grid');
  if (!grid) return;

  // Configuration
  var config = {
    gapH: parseInt(grid.dataset.gapH, 10) || 0,
    gapV: parseInt(grid.dataset.gapV, 10) || 0,
    colsMobile: parseInt(grid.dataset.colsMobile, 10) || 2,
    colsTablet: parseInt(grid.dataset.colsTablet, 10) || 3,
    colsDesktop: parseInt(grid.dataset.colsDesktop, 10) || 5,
    basePath: {{ base_path|json_encode|raw }},
    apiUrl: {{ (base_path ~ '/api/home/gallery')|json_encode|raw }},
    batchSize: 30
  };

  var msnry = null;
  var isInitialized = false;
  var isLoading = false;
  var hasMore = {{ has_more_images ? 'true' : 'false' }};
  var shownImageIds = new Set({{ shown_image_ids|json_encode|raw }});
  var prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Get current column count
  function getColumnCount() {
    var width = window.innerWidth;
    if (width >= 1025) return config.colsDesktop;
    if (width >= 641) return config.colsTablet;
    return config.colsMobile;
  }

  // Calculate item width
  function calculateItemWidth() {
    var cols = getColumnCount();
    var containerWidth = grid.offsetWidth;
    var totalGaps = config.gapH * (cols - 1);
    return Math.floor((containerWidth - totalGaps) / cols);
  }

  // Apply width to items
  function setItemWidths(items) {
    var width = calculateItemWidth();
    items = items || grid.querySelectorAll('.masonry-item');
    for (var i = 0; i < items.length; i++) {
      items[i].style.width = width + 'px';
      items[i].style.marginBottom = config.gapV + 'px';
    }
  }

  // Create image element from API data
  function createImageElement(img) {
    var div = document.createElement('div');
    div.className = 'masonry-item fade-in';
    div.style.width = calculateItemWidth() + 'px';
    div.style.marginBottom = config.gapV + 'px';

    var link = document.createElement('a');
    link.href = config.basePath + '/album/' + encodeURIComponent(img.album_slug);

    var picture = document.createElement('picture');

    // Add sources (avif, webp, jpg)
    ['avif', 'webp', 'jpg'].forEach(function(fmt) {
      var sources = img.sources && img.sources[fmt];
      if (sources && sources.length) {
        var source = document.createElement('source');
        source.type = 'image/' + (fmt === 'jpg' ? 'jpeg' : fmt);
        source.srcset = sources.join(', ');
        picture.appendChild(source);
      }
    });

    var imgEl = document.createElement('img');
    imgEl.src = img.fallback_src || img.url;
    imgEl.alt = img.alt || img.album_title || '';
    imgEl.width = img.width || 800;
    imgEl.height = img.height || 600;
    imgEl.loading = 'lazy';
    imgEl.style.aspectRatio = img.width + ' / ' + img.height;

    picture.appendChild(imgEl);
    link.appendChild(picture);
    div.appendChild(link);

    return div;
  }

  // Load more images from API
  function loadMoreImages(callback) {
    if (isLoading || !hasMore) {
      if (callback) callback();
      return;
    }

    isLoading = true;
    var excludeIds = Array.from(shownImageIds).join(',');
    var url = config.apiUrl + '?mode=masonry&limit=' + config.batchSize + '&exclude=' + excludeIds;

    fetch(url)
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (!data.images || !data.images.length) {
          hasMore = false;
          isLoading = false;
          if (callback) callback();
          return;
        }

        hasMore = data.hasMore;
        var newItems = [];

        data.images.forEach(function(img) {
          var id = parseInt(img.id, 10);
          if (shownImageIds.has(id)) return;
          shownImageIds.add(id);

          var el = createImageElement(img);
          newItems.push(el);
        });

        if (!newItems.length) {
          isLoading = false;
          if (callback) callback();
          return;
        }

        // Append to DOM
        var fragment = document.createDocumentFragment();
        newItems.forEach(function(item) { fragment.appendChild(item); });
        grid.appendChild(fragment);

        // Add to Masonry after images load
        imagesLoaded(newItems, function() {
          if (msnry) {
            msnry.appended(newItems);
            msnry.layout();
          }
          isLoading = false;
          if (window.lenisResize) window.lenisResize();
          if (callback) callback();
        });
      })
      .catch(function(err) {
        console.error('Masonry load error:', err);
        isLoading = false;
        if (callback) callback();
      });
  }

  // Initialize Masonry
  function initMasonry() {
    if (isInitialized) return;
    isInitialized = true;

    grid.classList.add('masonry-active');
    setItemWidths();

    msnry = new Masonry(grid, {
      itemSelector: '.masonry-item',
      columnWidth: '.masonry-item',
      gutter: config.gapH,
      percentPosition: false,
      horizontalOrder: false,
      transitionDuration: 0,
      initLayout: false,
      resize: false
    });

    msnry.layout();

    requestAnimationFrame(function() {
      msnry.layout();
      showGrid();
    });
  }

  // Show grid with animation
  function showGrid() {
    grid.classList.add('masonry-ready');
    var items = grid.querySelectorAll('.masonry-item');

    if (prefersReducedMotion) {
      for (var i = 0; i < items.length; i++) {
        items[i].classList.add('fade-in');
      }
    } else {
      // Staggered reveal
      var viewportHeight = window.innerHeight;
      var positions = [];
      for (var j = 0; j < items.length; j++) {
        var rect = items[j].getBoundingClientRect();
        positions.push({
          item: items[j],
          top: rect.top,
          left: rect.left,
          inViewport: rect.top < viewportHeight && rect.bottom > 0
        });
      }

      positions.sort(function(a, b) {
        var rowA = Math.round(a.top / 50);
        var rowB = Math.round(b.top / 50);
        if (rowA !== rowB) return rowA - rowB;
        return a.left - b.left;
      });

      var belowFoldIndex = 0;
      positions.forEach(function(pos) {
        if (pos.inViewport) {
          pos.item.classList.add('fade-in');
        } else {
          setTimeout(function() {
            pos.item.classList.add('fade-in');
          }, belowFoldIndex * 25);
          belowFoldIndex++;
        }
      });
    }

    if (window.lenisResize) {
      setTimeout(window.lenisResize, 100);
    }
  }

  // Handle resize
  var resizeTimeout;
  function handleResize() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      if (msnry) {
        setItemWidths();
        msnry.layout();
        if (window.lenisResize) window.lenisResize();
      }
    }, 150);
  }

  // Infinite scroll trigger
  function checkScroll() {
    if (isLoading || !hasMore) return;
    var scrollY = window.scrollY || window.pageYOffset;
    var windowHeight = window.innerHeight;
    var docHeight = document.documentElement.scrollHeight;

    // Load when within 2 viewports of bottom
    if (scrollY + windowHeight >= docHeight - (windowHeight * 2)) {
      loadMoreImages();
    }
  }

  // Initialize
  function init() {
    initMasonry();

    // Progressive layout as initial images load
    var imgLoad = imagesLoaded(grid);
    var layoutPending = false;

    imgLoad.on('progress', function() {
      if (!layoutPending && msnry) {
        layoutPending = true;
        requestAnimationFrame(function() {
          msnry.layout();
          layoutPending = false;
        });
      }
    });

    imgLoad.on('always', function() {
      if (msnry) msnry.layout();
    });
  }

  // Start
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.addEventListener('resize', handleResize, { passive: true });

  // Throttled scroll listener
  var scrollThrottle = null;
  window.addEventListener('scroll', function() {
    if (scrollThrottle) return;
    scrollThrottle = setTimeout(function() {
      scrollThrottle = null;
      checkScroll();
    }, 100);
  }, { passive: true });

  // Lenis scroll support
  if (window.lenisInstance && window.lenisInstance.on) {
    window.lenisInstance.on('scroll', checkScroll);
  }

})();
</script>
{% endblock %}
