{# ===== First-Visit Preloader Curtain =====
   Shows logo/title on first visit per session, then slides away (desktop) or fades out (mobile).
   Include this partial in home templates for a branded loading experience.
#}

<style nonce="{{ csp_nonce() }}">
/* First-Visit Preloader Curtain */
.preloader-curtain {
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    transform: translateY(0);
    transition: transform 0.65s cubic-bezier(0.76, 0, 0.24, 1);
    will-change: transform;
}
html.dark .preloader-curtain {
    background: #171717;
}
.preloader-curtain.preloader-exit {
    transform: translateY(-100%);
}
.preloader-curtain.preloader-hidden {
    display: none;
}
.preloader-content {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
.preloader-curtain.preloader-exit .preloader-content {
    opacity: 0;
    transform: translateY(-20px);
}
/* Mobile: use fadeout instead of slide-up */
@media (max-width: 767px) {
    .preloader-curtain {
        transform: none;
        opacity: 1;
        transition: opacity 0.5s ease-out;
        will-change: opacity;
    }
    .preloader-curtain.preloader-exit {
        transform: none;
        opacity: 0;
        pointer-events: none;
    }
    .preloader-content {
        transform: none;
    }
    .preloader-curtain.preloader-exit .preloader-content {
        transform: none;
    }
}
.preloader-logo {
    max-height: 80px;
    width: auto;
    max-width: 200px;
}
.preloader-title {
    font-family: var(--font-headings);
    font-weight: var(--font-headings-weight);
    font-size: 1.25rem;
    color: #171717;
}
@media (min-width: 768px) {
    .preloader-title {
        font-size: 2.5rem;
    }
}
html.dark .preloader-title {
    color: #fafafa;
}
/* Reduce animation for users who prefer it */
@media (prefers-reduced-motion: reduce) {
    .preloader-curtain {
        transition: opacity 0.2s ease;
        transform: none !important;
    }
    .preloader-curtain.preloader-exit {
        opacity: 0;
        transform: none !important;
    }
}
</style>

<!-- First-Visit Preloader Curtain -->
<div id="preloader-curtain" class="preloader-curtain preloader-hidden" aria-hidden="true">
    <div class="preloader-content">
        {% if logo_type == 'image' and site_logo %}
            <img src="{% if site_logo starts with '/' %}{{ base_path }}{{ site_logo }}{% else %}{{ site_logo }}{% endif %}" alt="{{ site_title|default('Portfolio')|e('html_attr') }}" class="preloader-logo">
        {% else %}
            <span class="preloader-title">{{ site_title|default('Portfolio') }}</span>
        {% endif %}
    </div>
</div>
<script nonce="{{ csp_nonce() }}">
(function() {
    // First-visit preloader - only show on first visit per session
    var preloader = document.getElementById('preloader-curtain');
    if (!preloader) return;

    try {
        // Check if this is first visit in this session
        if (!sessionStorage.getItem('cimaise_visited')) {
            // First visit - show preloader
            preloader.classList.remove('preloader-hidden');

            // Mark as visited
            sessionStorage.setItem('cimaise_visited', '1');

            // Dismiss after page load + brief delay
            var dismiss = function() {
                preloader.classList.add('preloader-exit');
                // Remove from DOM after animation completes
                setTimeout(function() {
                    preloader.classList.add('preloader-hidden');
                }, 700);
            };

            // Wait for DOM to be ready, then dismiss (don't wait for all images)
            if (document.readyState !== 'loading') {
                setTimeout(dismiss, 400);
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(dismiss, 400);
                }, { once: true });
            }
        }
    } catch (e) {
        // sessionStorage not available (private browsing) - skip preloader
        preloader.classList.add('preloader-hidden');
    }
})();
</script>
